<HTML> 
<HEAD>
<TITLE>Alton's Node_IRC_Client</TITLE>
</HEAD>
<BODY>
<CENTER><H3>Alton's Node IRC Client</H3></CENTER>

<SCRIPT>

var session_id = "";

// Load the config file up so we can use a few of its fields.
var Httpreq = new XMLHttpRequest();   
Httpreq.open("GET","/config_file",false);
Httpreq.send(null);
var config_file = JSON.parse(Httpreq.responseText);

// Write out the text (display) area and the input box.
document.write('<P><TEXTAREA STYLE="overflow-y: scroll; font-size:' + config_file.displayFontSize + 'px" ID="output_area" ROWS="' + config_file.displayRows    + '" COLS="' + config_file.displayColumns + '"> </TEXTAREA> </P>');
document.write('<P><FORM ONSUBMIT="sendChannelMessage(); return false;" >');
document.write('    <INPUT    STYLE="font-size:' + config_file.inputFontSize + 'px" ID="input_area" SIZE="' + config_file.displayColumns + '" />');
document.write('    <INPUT TYPE="submit" VALUE="Send"></FORM></P>');

// So we don't have to keep looking this up.
input_area  = document.getElementById('input_area' );
output_area = document.getElementById('output_area');

// Initialize the area so next text appears at the bottom of the output area.
var clearOutputArea = function() {
    output_area.value = "";
    for (var i=0; config_file.displayRows > i; i++)  // '>' used to quiet my language-sensitive editor.
        output_area.value += '\n';
    output_area.scrollTop = output_area.scrollHeight;
}

// Nickname will be obtained from the input box until it is set and accepted by the server.
var nickname = "";
clearOutputArea();
output_area.value += "Please enter your nickname below.\n";
output_area.scrollTop = output_area.scrollHeight;

var sendChannelMessage = function() {
    var message_to_send = input_area.value;
    input_area.value = "";  // Blank out the input box.
    if (nickname == "") {  // If the nickname hasn't been set yet, then use any input from this box to do it.
        nickname = message_to_send;
        var Httpreq = new XMLHttpRequest();
        Httpreq.open("GET","/connect?session_id=" + session_id + "&nickname=" + nickname, false);
        Httpreq.send(null);
        clearOutputArea();
        output_area.value += "Using nickname " + nickname + "\n";
        message_to_send = "";  // No need to send anything else at this point.
    }
    if (message_to_send != "") {
        var Httpreq = new XMLHttpRequest();
        Httpreq.open("GET","/send_channel_message?session_id=" + session_id + "&message=" + message_to_send, false);  // This is URL-encoded, fortunately.
        Httpreq.send(null);
        output_area.value += "(self): " + message_to_send + "\n";
        output_area.scrollTop = output_area.scrollHeight;
    }
    input_area.focus();
}

var pingNodeServer = function() {
    var Httpreq = new XMLHttpRequest();
    Httpreq.open("GET","/ping?session_id=" + session_id, false);
    Httpreq.send(null);
    setTimeout (function() { pingNodeServer(); }, 30000);  // Repeat this every 30 seconds.
}

var screenUpdate = function() {
    var Httpreq = new XMLHttpRequest();
    Httpreq.open("GET","/last_channel_message?session_id=" + session_id,false);
    Httpreq.send(null);
    var data_from_server = JSON.parse(Httpreq.responseText);
    while (data_from_server.lastChannelMessage != "") {
        //console.log(data_from_server.lastChannelMessage);
        output_area.value += data_from_server.lastChannelMessage + "\n";
        output_area.scrollTop = output_area.scrollHeight;
        var Httpreq = new XMLHttpRequest();  // Try again immediately, in case there are more messages.
        Httpreq.open("GET","/last_channel_message?session_id=" + session_id,false);
        Httpreq.send(null);
        data_from_server = JSON.parse(Httpreq.responseText);
        }
    setTimeout (function() { screenUpdate(); }, 1000);  // Poll the Node server and update the screen every second.
}

window.onload = function() {
    //
    // First get the session ID for ourselves.  This is not super high security, but ok enough for a chat.
    var Httpreq = new XMLHttpRequest();
    Httpreq.open("GET","/session_id",false);
    Httpreq.send(null);
    var data_from_server = JSON.parse(Httpreq.responseText);
    session_id = data_from_server.sessionId;
    console.log("Got session ID: " + session_id);
    //
    input_area.focus();
    setTimeout (function() { pingNodeServer(); }, 30000);  // Ping the Node server so it can detect if we've died and gone away.
    setTimeout (function() { screenUpdate();   },  1000);  // Poll the Node server and update the screen every second.
}
</SCRIPT>

</BODY>
</HTML>
